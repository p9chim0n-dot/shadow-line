<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>SHADOW LINE: RECT-GRID</title>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-database-compat.js"></script>
    <script src="https://unpkg.com/panzoom@9.4.0/dist/panzoom.min.js"></script>
    <style>
        :root { --accent-a: #00aaff; --accent-b: #ff4400; --bg: #050505; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); color: #ccc; margin: 0; padding: 0; touch-action: none; height: 100vh; display: flex; flex-direction: column; overflow: hidden; }
        
        .overlay { position: fixed; inset: 0; background: #000; z-index: 2000; display: flex; flex-direction: column; justify-content: center; align-items: center; padding: 20px; }
        .setup-btn { width: 100%; max-width: 320px; padding: 15px; margin: 10px; font-size: 16px; border: 1px solid #444; background: #222; color: #fff; cursor: pointer; }

        /* ã‚²ãƒ¼ãƒ ãƒ¡ã‚¤ãƒ³ */
        #game-layout { display: none; flex-direction: column; height: 100vh; width: 100vw; }
        
        /* ãƒãƒƒãƒ—ã‚¨ãƒªã‚¢ï¼šã‚¹ãƒãƒ›ç‰ˆã¯ã“ã“ã‚’ãƒ‰ãƒ©ãƒƒã‚°/ã‚ºãƒ¼ãƒ å¯èƒ½ã«ã™ã‚‹ */
        #map-viewport { flex: 1; overflow: hidden; position: relative; background: #000; cursor: grab; }
        #map-viewport:active { cursor: grabbing; }

        #game-container { 
            display: grid; 
            gap: 10px; 
            padding: 40px;
            transform-origin: 0 0; /* Panzoomç”¨ */
        }

        /* PCç‰ˆï¼šæ¨ªé•·é•·æ–¹å½¢ï¼ˆ10åˆ—Ã—3è¡Œï¼‰ */
        @media (min-width: 768px) {
            #game-container { 
                grid-template-columns: repeat(10, 120px); 
                grid-template-rows: repeat(3, 80px);
                width: max-content;
            }
        }

        /* ã‚¹ãƒãƒ›ç‰ˆï¼šç¸¦é•·é•·æ–¹å½¢ï¼ˆ3åˆ—Ã—10è¡Œï¼‰ */
        @media (max-width: 767px) {
            #game-container { 
                grid-template-columns: repeat(3, 100px); 
                grid-template-rows: repeat(10, 70px);
                width: max-content;
            }
        }

        .station { 
            background: rgba(20, 20, 20, 0.9); border: 1px solid #333;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            border-radius: 4px; color: #aaa; cursor: pointer; font-size: 12px;
            position: relative; transition: 0.2s;
        }
        .station.selected { border-color: #fff; box-shadow: 0 0 15px #fff; z-index: 10; color: #fff; background: #111; }
        .station.blocked { background: #300 !important; border-color: #f00 !important; }

        .unit-marker { display: flex; width: 16px; height: 16px; border-radius: 2px; margin: 1px; font-size: 10px; align-items: center; justify-content: center; font-weight: bold; color: #fff; }
        .u-a { background: var(--accent-a); } .u-b { background: var(--accent-b); }

        /* æ“ä½œãƒ‘ãƒãƒ« */
        #controls { background: #111; border-top: 1px solid #333; padding: 10px; z-index: 100; touch-action: auto; }
        .unit-tabs { display: flex; gap: 4px; margin-bottom: 8px; overflow-x: auto; }
        .tab { flex: 1; padding: 12px; font-size: 12px; background: #222; border: 1px solid #444; color: #666; white-space: nowrap; }
        .tab.active { background: #444; color: #fff; border-color: #fff; }
        .tab.done { opacity: 0.2; }

        .actions { display: grid; grid-template-columns: repeat(4, 1fr); gap: 6px; }
        @media (max-width: 600px) { .actions { grid-template-columns: repeat(2, 1fr); } }
        
        #confirm-modal { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 85%; max-width: 300px; background: #111; border: 2px solid #ffeb3b; padding: 20px; z-index: 3000; display: none; text-align: center; border-radius: 8px; }
    </style>
</head>
<body>

<div id="setup-screen" class="overlay">
    <h1 style="color:var(--accent-b)">SHADOW LINE</h1>
    <button class="setup-btn" onclick="preJoin('æœæŸ»å®˜')">æœæŸ»å®˜ã¨ã—ã¦å‚åŠ </button>
    <button class="setup-btn" onclick="preJoin('çˆ†å¼¾é­”')">çˆ†å¼¾é­”ã¨ã—ã¦å‚åŠ </button>
</div>

<div id="char-select-screen" class="overlay" style="display:none;">
    <h2 id="char-title"></h2>
    <div id="char-list" style="display:grid; grid-template-columns: repeat(2, 1fr); gap:10px; margin:20px;"></div>
    <button class="setup-btn" id="start-btn" onclick="finalizeSelection()" style="display:none; border-color:#0f0;">é…ç½®ã‚’å®Œäº†</button>
</div>

<div id="confirm-modal">
    <p id="confirm-text" style="color:#fff;"></p>
    <div style="display:flex; gap:10px;"><button onclick="processAction(true)" style="background:#0f0; flex:1; padding:12px;">å®Ÿè¡Œ</button><button onclick="processAction(false)" style="background:#555; flex:1; padding:12px;">ä¸­æ­¢</button></div>
</div>

<div id="game-layout">
    <div id="map-viewport">
        <div id="game-container"></div>
    </div>
    <div id="controls">
        <div style="display:flex; justify-content:space-between; font-size:12px; margin-bottom:5px;">
            <div id="turn-msg"></div>
            <div id="scores">A:0 | B:0</div>
        </div>
        <div id="unit-tabs" class="unit-tabs"></div>
        <div id="action-btns" class="actions"></div>
    </div>
</div>

<script>
// --- [Firebase Config] ---
const firebaseConfig = {
  apiKey: "AIzaSyCoYzyTFHBNUbo3ZvG3sZFLdW7j0HcD91s",
  authDomain: "shadow-line-game.firebaseapp.com",
  databaseURL: "https://shadow-line-game-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "shadow-line-game",
  storageBucket: "shadow-line-game.firebasestorage.app",
  messagingSenderId: "105815703910",
  appId: "1:105815703910:web:dff1c672aa30120b9b88a7"
};
// -------------------------

firebase.initializeApp(firebaseConfig);
const db = firebase.database().ref('shadow_line_v4_zoom');

const STATIONS = ["æ±åˆ»", "ç¥ä¼", "é›»è„³è¡—", "å¾¡å¾’åŸ", "ä¸Šç•Œ", "é¶¯ãƒæœ", "æ—¥æš®å²¬", "è¥¿æš®", "ç”°ç‘", "é§’è¾¼æ¥¼", "å·£é­”", "å¤§æŸ", "æ± è¢‹ç„", "ç›®ç™½éš ", "é¦¬å ´å´", "æ–°å¤§çªª", "æ½œå®¿", "ä»£ã€…éš…", "åŸå®¿å±¤", "æ¸‹å¤œ", "æµæ¯”å·", "ç›®é»’ç•Œ", "åç”°", "å¤§å´è·¡", "å“æ²³", "é«˜è¼ªé–€", "ç”°æº€", "æµœæ¾å®®", "æ–°ç ´", "æœ‰æ¥½åºµ"];

const ABILITIES = {
    'æœæŸ»å®˜': [{id:1, name:"ç‰¹æ€¥"}, {id:2, name:"äºˆçŸ¥"}, {id:3, name:"èè¾¼"}, {id:4, name:"å‡¦ç†"}, {id:5, name:"è¦†é¢"}, {id:6, name:"èª¿æŸ»"}],
    'çˆ†å¼¾é­”': [{id:1, name:"ç›—è´"}, {id:2, name:"é›»è»Š"}, {id:3, name:"æ‰‹é…"}, {id:4, name:"äºˆå‘Š"}]
};

let myRole = null, selectedIds = [], gameState = null, activeIdx = 0, selectedSt = null, pendingAct = null, pz = null;

function preJoin(role) {
    myRole = role;
    document.getElementById('setup-screen').style.display = 'none';
    document.getElementById('char-select-screen').style.display = 'flex';
    const list = document.getElementById('char-list');
    const limit = role === 'æœæŸ»å®˜' ? 4 : 2;
    document.getElementById('char-title').innerText = `${role}é¸æŠ(${limit})`;

    ABILITIES[role].forEach(c => {
        const d = document.createElement('div');
        d.className = 'char-card'; d.style.cssText = "background:#111; border:1px solid #333; padding:10px; cursor:pointer;";
        d.innerHTML = `<strong>${c.name}</strong>`;
        d.onclick = () => {
            if(selectedIds.includes(c.id)) { selectedIds = selectedIds.filter(i => i !== c.id); d.style.borderColor = "#333"; }
            else if(selectedIds.length < limit) { selectedIds.push(c.id); d.style.borderColor = "#0f0"; }
            document.getElementById('start-btn').style.display = selectedIds.length === limit ? 'block' : 'none';
        };
        list.appendChild(d);
    });
}

function finalizeSelection() {
    document.getElementById('char-select-screen').style.display = 'none';
    document.getElementById('game-layout').style.display = 'flex';
    renderMap();
    // ã‚ºãƒ¼ãƒ æ©Ÿèƒ½ã®åˆæœŸåŒ–
    pz = panzoom(document.getElementById('game-container'), {
        maxZoom: 2, minZoom: 0.5, bounds: true, boundsPadding: 0.1
    });
    initSync();
}

function renderMap() {
    const container = document.getElementById('game-container');
    container.innerHTML = "";
    STATIONS.forEach((name, i) => {
        const el = document.createElement('div');
        el.className = 'station'; el.id = `st-${i}`;
        el.innerHTML = `<span>${name}</span><div id="m-${i}" style="display:flex; margin-top:4px;"></div>`;
        el.onclick = (e) => { 
            // Panzoomã®ãƒ‰ãƒ©ãƒƒã‚°ä¸­ã«ã¯åå¿œã•ã›ãªã„
            if (e.defaultPrevented) return;
            if(gameState?.turn === myRole) { selectedSt = i; updateUI(); }
        };
        container.appendChild(el);
    });
}

function initSync() {
    db.on('value', snap => {
        const data = snap.val();
        if(!data) {
            let bPos = [], aPos = [], used = new Set();
            while(bPos.length < 2) { let p = Math.floor(Math.random()*30); if(!used.has(p)){bPos.push(p); used.add(p);}}
            while(aPos.length < 4) { let p = Math.floor(Math.random()*30); if(!used.has(p) && bPos.every(bp => Math.min(Math.abs(p-bp), 30-Math.abs(p-bp))>2)){aPos.push(p); used.add(p);}}
            db.set({ turn:'çˆ†å¼¾é­”', aScore:0, bScore:0, aUnits:aPos, bUnits:bPos, aChars:myRole==='æœæŸ»å®˜'?selectedIds:[1,2,3,4], bChars:myRole==='çˆ†å¼¾é­”'?selectedIds:[1,2], aDone:[false,false,false,false], bDone:[false,false], bombs:{}, blocked:{} });
        } else {
            gameState = data;
            if(myRole==='æœæŸ»å®˜' && !gameState.aChars) db.update({aChars: selectedIds});
            if(myRole==='çˆ†å¼¾é­”' && !gameState.bChars) db.update({bChars: selectedIds});
            updateUI();
        }
    });
}

function updateUI() {
    if(!gameState) return;
    document.getElementById('scores').innerText = `è§£:${gameState.aScore} | çˆ†:${gameState.bScore}`;
    document.getElementById('turn-msg').innerText = gameState.turn === myRole ? "â–¶ è‡ªã‚¿ãƒ¼ãƒ³" : "âŒ› ç›¸æ‰‹å¾…ã¡";
    
    const tContainer = document.getElementById('unit-tabs'); tContainer.innerHTML = "";
    const curChars = myRole==='æœæŸ»å®˜'?gameState.aChars:gameState.bChars;
    const curDone = myRole==='æœæŸ»å®˜'?gameState.aDone:gameState.bDone;
    
    curChars.forEach((id, idx) => {
        const btn = document.createElement('button');
        btn.className = `tab ${activeIdx===idx?'active':''} ${curDone[idx]?'done':''}`;
        btn.innerText = ABILITIES[myRole].find(c=>c.id===id).name;
        btn.onclick = () => { if(gameState.turn===myRole){ activeIdx=idx; updateUI(); }};
        tContainer.appendChild(btn);
    });

    const bContainer = document.getElementById('action-btns'); bContainer.innerHTML = "";
    if(gameState.turn === myRole) {
        const acts = myRole==='æœæŸ»å®˜'?["ç§»å‹•","è§£é™¤","æ•ç¸›","å°é–"]:["ç§»å‹•","è¨­ç½®","çˆ†ç ´"];
        acts.forEach(a => {
            const b = document.createElement('button'); b.innerText = a; b.disabled = curDone[activeIdx];
            b.onclick = () => { if(selectedSt!==null || a==="çˆ†ç ´") confirmAct(a); };
            bContainer.appendChild(b);
        });
    }

    STATIONS.forEach((name, i) => {
        const el = document.getElementById(`st-${i}`);
        if(!el) return;
        el.className = 'station' + (i===selectedSt?' selected':'') + (gameState.blocked?.[i]?' blocked':'');
        const m = el.querySelector(`#m-${i}`); m.innerHTML = "";
        gameState.aUnits.forEach((p, idx) => { if(p===i) m.innerHTML += `<div class="unit-marker u-a">${idx+1}</div>`; });
        gameState.bUnits.forEach((p, idx) => { if(p===i) m.innerHTML += `<div class="unit-marker u-b">${idx+1}</div>`; });
        if(myRole==='çˆ†å¼¾é­”' && gameState.bombs?.[i]) el.querySelector('span').innerHTML = name + "ğŸ’£";
    });
}

function confirmAct(a) { 
    pendingAct = a; 
    const stName = selectedSt !== null ? STATIONS[selectedSt] : "å…¨åŸŸ";
    document.getElementById('confirm-text').innerText = `${stName}ã§ã€Œ${a}ã€ã‚’å®Ÿè¡Œï¼Ÿ`; 
    document.getElementById('confirm-modal').style.display = 'block'; 
}

function processAction(yes) {
    document.getElementById('confirm-modal').style.display = 'none';
    if(!yes) return;
    let up = JSON.parse(JSON.stringify(gameState));
    const s = selectedSt, cur = (myRole==='æœæŸ»å®˜'?up.aUnits:up.bUnits)[activeIdx];
    let actionResult = "SUCCESS";

    if(myRole==='æœæŸ»å®˜') {
        if(pendingAct==="ç§»å‹•") {
            if(isWithin(cur, s, (up.aChars[activeIdx]===1?3:1)) && !up.blocked?.[s]) { up.aUnits[activeIdx]=s; }
            else { actionResult = "FAILED"; }
        } else if(pendingAct==="è§£é™¤") {
            if(s===cur && up.bombs?.[s]) { delete up.bombs[s]; up.aScore++; }
            else { actionResult = "FAILED"; }
        } else if(pendingAct==="æ•ç¸›") {
            if(s===cur && up.bUnits.includes(s)) { alert("æœæŸ»å®˜å‹åˆ©ï¼"); db.set(null); location.reload(); return; }
            else { actionResult = "FAILED"; }
        } else if(pendingAct==="å°é–") { 
            if(!up.blocked) up.blocked={}; up.blocked[s]=4; 
        }
        up.aDone[activeIdx]=true;
    } else {
        if(pendingAct==="ç§»å‹•") {
            if(isWithin(cur, s, 1) && !up.blocked?.[s]) { up.bUnits[activeIdx]=s; }
            else { actionResult = "FAILED"; }
        } else if(pendingAct==="è¨­ç½®") {
            if(s===cur) { if(!up.bombs) up.bombs={}; up.bombs[s]=5; }
            else { actionResult = "FAILED"; }
        } else if(pendingAct==="çˆ†ç ´") { 
            let hits = false;
            for(let b in up.bombs) if(up.bombs[b]<=0){ 
                up.bScore++; 
                if(up.aUnits.includes(parseInt(b))){alert("çˆ†å¼¾é­”å‹åˆ©ï¼"); db.set(null); location.reload(); return;} 
                delete up.bombs[b]; hits = true;
            }
            if(!hits) actionResult = "FAILED";
        }
        up.bDone[activeIdx]=true;
    }

    if(actionResult === "FAILED") console.log(`${pendingAct} action failed, but action point consumed.`);

    const dArr = myRole==='æœæŸ»å®˜'?up.aDone:up.bDone;
    if(dArr.every(d=>d)) {
        up.turn = myRole==='æœæŸ»å®˜'?'çˆ†å¼¾é­”':'æœæŸ»å®˜';
        up.aDone=[false,false,false,false]; up.bDone=[false,false];
        if(up.turn==='æœæŸ»å®˜') { for(let b in up.bombs) if(up.bombs[b]>0) up.bombs[b]--; }
        activeIdx=0;
    } else { activeIdx = dArr.findIndex(d=>!d); }
    selectedSt=null; db.set(up);
}

function isWithin(p1, p2, r) { let d = Math.abs(p1-p2); return Math.min(d, 30-d) <= r && p1!==p2; }
</script>
</body>
</html>