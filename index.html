<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>SHADOW LINE: STRATEGY Ver 2.0</title>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-database-compat.js"></script>
    <style>
        :root { --accent-a: #00aaff; --accent-b: #ff4400; --bg: #050505; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); color: #ccc; margin: 0; padding: 0; touch-action: manipulation; overflow: hidden; height: 100vh; }
        
        /* é¸æŠç”»é¢ */
        .overlay { position: fixed; inset: 0; background: #000; z-index: 2000; display: flex; flex-direction: column; justify-content: center; align-items: center; padding: 20px; }
        .setup-btn { width: 100%; max-width: 320px; padding: 15px; margin: 10px; font-size: 16px; border: 1px solid #444; background: #222; color: #fff; cursor: pointer; }
        .char-grid { width: 100%; max-width: 600px; display: grid; grid-template-columns: repeat(auto-fit, minmax(130px, 1fr)); gap: 10px; margin: 20px 0; overflow-y: auto; }
        .char-card { background: #111; border: 1px solid #333; padding: 10px; font-size: 12px; cursor: pointer; border-radius: 4px; text-align: left; }
        .char-card.selected { border-color: #0f0; background: #002200; }

        /* ã‚²ãƒ¼ãƒ ãƒ¡ã‚¤ãƒ³ */
        #game-layout { display: none; flex-direction: column; height: 100vh; }
        #map-area { flex: 1; position: relative; overflow: hidden; background: radial-gradient(circle, #0a1520 0%, #000 100%); }
        #game-container { position: absolute; width: 100%; height: 100%; }

        .station { 
            position: absolute; width: 65px; height: 35px; font-size: 10px;
            background: rgba(0,0,0,0.85); border: 1px solid #333;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            transform: translate(-50%, -50%); border-radius: 4px; color: #aaa;
        }
        @media (min-width: 768px) { .station { width: 90px; height: 40px; font-size: 12px; } }
        .station.selected { border-color: #fff; color: #fff; box-shadow: 0 0 12px #fff; z-index: 100; }
        .station.blocked { background: #300 !important; border-color: #f00 !important; color: #f44 !important; }

        .unit-marker { display: flex; width: 14px; height: 14px; border-radius: 2px; margin: 1px; font-size: 9px; align-items: center; justify-content: center; font-weight: bold; color: #fff; }
        .u-a { background: var(--accent-a); } .u-b { background: var(--accent-b); }

        /* æ“ä½œãƒ‘ãƒãƒ« */
        #controls { background: #111; border-top: 1px solid #333; padding: 10px; }
        .info-bar { display: flex; justify-content: space-between; margin-bottom: 8px; font-size: 13px; font-weight: bold; }
        .unit-tabs { display: flex; gap: 4px; margin-bottom: 8px; overflow-x: auto; }
        .tab { flex: 1; padding: 10px 4px; font-size: 11px; background: #222; border: 1px solid #444; color: #777; white-space: nowrap; }
        .tab.active { background: #444; color: #fff; border-color: #fff; }
        .tab.done { opacity: 0.2; text-decoration: line-through; }

        .actions { display: grid; grid-template-columns: repeat(4, 1fr); gap: 6px; }
        @media (max-width: 600px) { .actions { grid-template-columns: repeat(2, 1fr); } }
        .actions button { padding: 12px; font-size: 13px; font-weight: bold; }
        
        #confirm-modal { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 85%; max-width: 300px; background: #111; border: 2px solid #ffeb3b; padding: 20px; z-index: 3000; display: none; text-align: center; border-radius: 8px; }
    </style>
</head>
<body>

<div id="setup-screen" class="overlay">
    <h1 style="color:var(--accent-b)">SHADOW LINE</h1>
    <button class="setup-btn" onclick="preJoin('æœæŸ»å®˜')">æœæŸ»å®˜ã¨ã—ã¦å‚åŠ  (4ä½“æ“ä½œ)</button>
    <button class="setup-btn" onclick="preJoin('çˆ†å¼¾é­”')">çˆ†å¼¾é­”ã¨ã—ã¦å‚åŠ  (2ä½“æ“ä½œ)</button>
</div>

<div id="char-select-screen" class="overlay" style="display:none;">
    <h2 id="char-title"></h2>
    <div id="char-list" class="char-grid"></div>
    <button class="setup-btn" id="start-btn" onclick="finalizeSelection()" style="display:none; border-color:#0f0;">åˆæœŸé…ç½®ã‚’å®Œäº†ã™ã‚‹</button>
</div>

<div id="confirm-modal">
    <p id="confirm-text" style="color:#fff; margin-bottom:20px;"></p>
    <div style="display:flex; gap:10px;">
        <button onclick="processAction(true)" style="background:#0f0; color:#000; flex:1; padding:12px;">å®Ÿè¡Œ</button>
        <button onclick="processAction(false)" style="background:#555; flex:1; padding:12px;">ä¸­æ­¢</button>
    </div>
</div>

<div id="game-layout">
    <div id="map-area"><div id="game-container"></div></div>
    <div id="controls">
        <div class="info-bar">
            <div id="turn-msg"></div>
            <div id="scores">A:0 | B:0</div>
        </div>
        <div id="unit-tabs" class="unit-tabs"></div>
        <div id="action-btns" class="actions"></div>
    </div>
</div>

<script>
// --- [Firebase Configã‚’è²¼ã‚Šä»˜ã‘ã¦ãã ã•ã„] ---
const firebaseConfig = {
  apiKey: "AIzaSyCoYzyTFHBNUbo3ZvG3sZFLdW7j0HcD91s",
  authDomain: "shadow-line-game.firebaseapp.com",
  databaseURL: "https://shadow-line-game-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "shadow-line-game",
  storageBucket: "shadow-line-game.firebasestorage.app",
  messagingSenderId: "105815703910",
  appId: "1:105815703910:web:dff1c672aa30120b9b88a7"
};
// ------------------------------------------

firebase.initializeApp(firebaseConfig);
const db = firebase.database().ref('shadow_line_v2_final');

const STATIONS = ["æ±åˆ»", "ç¥ä¼", "é›»è„³è¡—", "å¾¡å¾’åŸ", "ä¸Šç•Œ", "é¶¯ãƒæœ", "æ—¥æš®å²¬", "è¥¿æš®", "ç”°ç‘", "é§’è¾¼æ¥¼", "å·£é­”", "å¤§æŸ", "æ± è¢‹ç„", "ç›®ç™½éš ", "é¦¬å ´å´", "æ–°å¤§çªª", "æ½œå®¿", "ä»£ã€…éš…", "åŸå®¿å±¤", "æ¸‹å¤œ", "æµæ¯”å·", "ç›®é»’ç•Œ", "åç”°", "å¤§å´è·¡", "å“æ²³", "é«˜è¼ªé–€", "ç”°æº€", "æµœæ¾å®®", "æ–°ç ´", "æœ‰æ¥½åºµ"];

const ABILITIES = {
    'æœæŸ»å®˜': [
        {id:1, name:"ç‰¹æ€¥", desc:"ç§»å‹•+2"}, {id:2, name:"äºˆçŸ¥", desc:"çˆ†å¼¾æ¤œçŸ¥"},
        {id:3, name:"èè¾¼", desc:"å±¥æ­´èª¿æŸ»"}, {id:4, name:"å‡¦ç†", desc:"è€æ€§ã‚ã‚Š"},
        {id:5, name:"è¦†é¢", desc:"éš å¯†æ€§"}, {id:6, name:"èª¿æŸ»", desc:"é€ƒèµ°æ–¹å‘"}
    ],
    'çˆ†å¼¾é­”': [
        {id:1, name:"ç›—è´", desc:"æ•µèƒ½åŠ›æŠŠæ¡"}, {id:2, name:"é›»è»Š", desc:"ç§»å‹•çˆ†å¼¾"},
        {id:3, name:"æ‰‹é…", desc:"æ¥è¿‘æ¤œçŸ¥"}, {id:4, name:"äºˆå‘Š", desc:"ãƒ€ãƒŸãƒ¼é€šçŸ¥"}
    ]
};

let myRole = null, selectedIds = [], gameState = null, activeIdx = 0, selectedSt = null, pendingAct = null;

function preJoin(role) {
    myRole = role;
    document.getElementById('setup-screen').style.display = 'none';
    document.getElementById('char-select-screen').style.display = 'flex';
    const list = document.getElementById('char-list'); list.innerHTML = "";
    const limit = role === 'æœæŸ»å®˜' ? 4 : 2;
    document.getElementById('char-title').innerText = `${role} ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼é¸æŠ (${limit})`;

    ABILITIES[role].forEach(c => {
        const d = document.createElement('div');
        d.className = 'char-card';
        d.innerHTML = `<strong>${c.name}</strong><br>${c.desc}`;
        d.onclick = () => {
            if(selectedIds.includes(c.id)) {
                selectedIds = selectedIds.filter(i => i !== c.id);
                d.classList.remove('selected');
            } else if(selectedIds.length < limit) {
                selectedIds.push(c.id);
                d.classList.add('selected');
            }
            document.getElementById('start-btn').style.display = selectedIds.length === limit ? 'block' : 'none';
        };
        list.appendChild(d);
    });
}

function finalizeSelection() {
    document.getElementById('char-select-screen').style.display = 'none';
    document.getElementById('game-layout').style.display = 'flex';
    renderMap();
    initSync();
}

function renderMap() {
    const container = document.getElementById('game-container');
    container.innerHTML = "";
    const w = container.offsetWidth, h = container.offsetHeight;
    const rX = Math.min(w, h) * 0.4, rY = Math.min(w, h) * 0.42;
    const cX = w / 2, cY = h / 2;

    STATIONS.forEach((name, i) => {
        const angle = (i / 30) * Math.PI * 2 - Math.PI / 2;
        const el = document.createElement('div');
        el.className = 'station'; el.id = `st-${i}`;
        el.style.left = (cX + rX * Math.cos(angle)) + 'px';
        el.style.top = (cY + rY * Math.sin(angle)) + 'px';
        el.innerHTML = `<span>${name}</span>`;
        el.onclick = () => { if(gameState?.turn === myRole) { selectedSt = i; updateUI(); }};
        container.appendChild(el);
    });
}

function initSync() {
    db.on('value', snap => {
        const data = snap.val();
        if(!data) {
            // åˆæœŸé…ç½®ã®è¨ˆç®—
            const aPos = [], bPos = [];
            const used = new Set();
            
            // çˆ†å¼¾é­”ã®é…ç½® (0, 15ã‚’ãƒ™ãƒ¼ã‚¹ã«èª¿æ•´)
            while(bPos.length < 2) {
                let p = Math.floor(Math.random() * 30);
                if(!used.has(p)) { bPos.push(p); used.add(p); }
            }
            // æœæŸ»å®˜ã®é…ç½® (æ•µã‹ã‚‰2é§…ä»¥ä¸Šé›¢ã‚Œã‚‹)
            while(aPos.length < 4) {
                let p = Math.floor(Math.random() * 30);
                let farEnough = bPos.every(bp => getDist(p, bp) > 2);
                if(!used.has(p) && farEnough) { aPos.push(p); used.add(p); }
            }

            db.set({
                turn: 'çˆ†å¼¾é­”', aScore:0, bScore:0, aUnits: aPos, bUnits: bPos,
                aChars: myRole==='æœæŸ»å®˜'?selectedIds:[1,2,3,4],
                bChars: myRole==='çˆ†å¼¾é­”'?selectedIds:[1,2],
                aDone:[false,false,false,false], bDone:[false,false],
                bombs:{}, blocked:{}, blockedQueue:[]
            });
        } else {
            gameState = data;
            // è‡ªåˆ†ã®ã‚­ãƒ£ãƒ©è¨­å®šã‚’æ›´æ–°
            if(myRole==='æœæŸ»å®˜' && !gameState.aChars) db.update({aChars: selectedIds});
            if(myRole==='çˆ†å¼¾é­”' && !gameState.bChars) db.update({bChars: selectedIds});
            updateUI();
        }
    });
}

function updateUI() {
    if(!gameState) return;
    document.getElementById('scores').innerText = `è§£é™¤:${gameState.aScore} | çˆ†ç ´:${gameState.bScore}`;
    const msg = document.getElementById('turn-msg');
    msg.innerText = gameState.turn === myRole ? "â–¶ ã‚ãªãŸã®ã‚¿ãƒ¼ãƒ³" : "âŒ› ç›¸æ‰‹ã®ã‚¿ãƒ¼ãƒ³";
    msg.style.color = gameState.turn === myRole ? "#0f0" : "#777";

    // ãƒ¦ãƒ‹ãƒƒãƒˆé¸æŠã‚¿ãƒ– (é †ä¸åŒæ“ä½œã®ãŸã‚)
    const tContainer = document.getElementById('unit-tabs'); tContainer.innerHTML = "";
    const curChars = myRole==='æœæŸ»å®˜'?gameState.aChars:gameState.bChars;
    const curDone = myRole==='æœæŸ»å®˜'?gameState.aDone:gameState.bDone;
    
    curChars.forEach((id, idx) => {
        const char = ABILITIES[myRole].find(c => c.id === id);
        const btn = document.createElement('button');
        btn.className = `tab ${activeIdx===idx?'active':''} ${curDone[idx]?'done':''}`;
        btn.innerText = char.name;
        btn.onclick = () => { if(gameState.turn === myRole) { activeIdx = idx; updateUI(); }};
        tContainer.appendChild(btn);
    });

    // ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãƒœã‚¿ãƒ³
    const bContainer = document.getElementById('action-btns'); bContainer.innerHTML = "";
    if(gameState.turn === myRole) {
        const acts = myRole==='æœæŸ»å®˜'?["ç§»å‹•","è§£é™¤","æ•ç¸›","å°é–"]:["ç§»å‹•","è¨­ç½®","çˆ†ç ´"];
        acts.forEach(a => {
            const b = document.createElement('button');
            b.innerText = a; b.disabled = curDone[activeIdx];
            b.onclick = () => { if(selectedSt!==null || a==="çˆ†ç ´") confirmAct(a); };
            bContainer.appendChild(b);
        });
    }

    // ãƒãƒƒãƒ—è¡¨ç¤ºã®æ›´æ–°
    STATIONS.forEach((name, i) => {
        const el = document.getElementById(`st-${i}`);
        if(!el) return;
        el.className = 'station' + (i===selectedSt?' selected':'') + (gameState.blocked?.[i]?' blocked':'');
        el.innerHTML = `<span>${name}</span><div id="m-${i}" style="display:flex;justify-content:center;"></div>`;
        const m = el.querySelector(`#m-${i}`);
        
        gameState.aUnits.forEach((p, idx) => { if(p===i) m.innerHTML += `<div class="unit-marker u-a">${idx+1}</div>`; });
        gameState.bUnits.forEach((p, idx) => { if(p===i) m.innerHTML += `<div class="unit-marker u-b">${idx+1}</div>`; });
        
        if(myRole==='çˆ†å¼¾é­”' && gameState.bombs?.[i]) el.innerHTML += `<span style="color:#f90;font-size:9px;">ğŸ’£${gameState.bombs[i]}</span>`;
        if(myRole==='æœæŸ»å®˜' && gameState.aChars?.includes(2) && gameState.bombs?.[i]===1) el.innerHTML += "âš ï¸";
    });
}

function confirmAct(a) {
    pendingAct = a;
    const stName = selectedSt !== null ? STATIONS[selectedSt] : "æŒ‡å®šãªã—";
    document.getElementById('confirm-text').innerText = `${stName}ã§ã€Œ${a}ã€ã‚’å®Ÿè¡Œã—ã¾ã™ã‹ï¼Ÿ`;
    document.getElementById('confirm-modal').style.display = 'block';
}

function processAction(yes) {
    document.getElementById('confirm-modal').style.display = 'none';
    if(!yes) return;
    let up = JSON.parse(JSON.stringify(gameState));
    const s = selectedSt, cur = (myRole==='æœæŸ»å®˜'?up.aUnits:up.bUnits)[activeIdx];
    let ok = false;

    if(myRole==='æœæŸ»å®˜') {
        const cid = up.aChars[activeIdx];
        if(pendingAct==="ç§»å‹•") {
            const r = cid === 1 ? 3 : 1;
            if(isWithin(cur, s, r) && !up.blocked?.[s]) { up.aUnits[activeIdx] = s; ok = true; }
        } else if(pendingAct==="è§£é™¤") {
            if(s===cur && up.bombs?.[s]) { delete up.bombs[s]; up.aScore++; ok = true; }
        } else if(pendingAct==="æ•ç¸›") {
            if(s===cur && up.bUnits.includes(s)) { alert("å‹åˆ©ï¼šçˆ†å¼¾é­”ã‚’ç¢ºä¿ã—ã¾ã—ãŸï¼"); db.set(null); location.reload(); return; }
        } else if(pendingAct==="å°é–") {
            if(!up.blocked) up.blocked = {}; up.blocked[s] = 4; up.blockedQueue.push(s);
            if(up.blockedQueue.length > 2) delete up.blocked[up.blockedQueue.shift()]; ok = true;
        }
        if(ok) up.aDone[activeIdx] = true;
    } else {
        if(pendingAct==="ç§»å‹•") {
            if(isWithin(cur, s, 1) && !up.blocked?.[s]) { up.bUnits[activeIdx] = s; ok = true; }
        } else if(pendingAct==="è¨­ç½®") {
            if(s===cur) { if(!up.bombs) up.bombs = {}; up.bombs[s] = 5; ok = true; }
        } else if(pendingAct==="çˆ†ç ´") {
            for(let b in up.bombs) if(up.bombs[b] <= 0) {
                up.bScore++; if(!up.blocked) up.blocked = {}; up.blocked[b] = 4;
                if(up.aUnits.includes(parseInt(b))) { alert("å‹åˆ©ï¼šæœæŸ»å®˜ã‚’çˆ†ç ´ã—ã¾ã—ãŸï¼"); db.set(null); location.reload(); return; }
                delete up.bombs[b]; ok = true;
            }
        }
        if(ok) up.bDone[activeIdx] = true;
    }

    // ã‚¿ãƒ¼ãƒ³çµ‚äº†åˆ¤å®š
    const doneArr = myRole==='æœæŸ»å®˜'?up.aDone:up.bDone;
    if(doneArr.every(d => d)) {
        up.turn = myRole==='æœæŸ»å®˜'?'çˆ†å¼¾é­”':'æœæŸ»å®˜';
        up.aDone = [false,false,false,false]; up.bDone = [false,false];
        if(up.turn==='æœæŸ»å®˜') {
            for(let b in up.bombs) if(up.bombs[b]>0) up.bombs[b]--;
            for(let bl in up.blocked) { up.blocked[bl]--; if(up.blocked[bl]<=0) delete up.blocked[bl]; }
        }
        activeIdx = 0;
    } else {
        // æ¬¡ã®æœªè¡Œå‹•ãƒ¦ãƒ‹ãƒƒãƒˆã¸è‡ªå‹•åˆ‡ã‚Šæ›¿ãˆï¼ˆã¾ãŸã¯ãã®ã¾ã¾é¸æŠå¯èƒ½ï¼‰
        activeIdx = doneArr.findIndex(d => !d);
    }
    selectedSt = null;
    db.set(up);
}

function getDist(p1, p2) {
    const d = Math.abs(p1 - p2);
    return Math.min(d, 30 - d);
}

function isWithin(p1, p2, r) { 
    return getDist(p1, p2) <= r && p1 !== p2;
}
</script>
</body>
</html>