<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>SHADOW LINE: ABILITY PROTOCOL - FIXED</title>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-database-compat.js"></script>
    <style>
        /* „Çπ„Çø„Ç§„É´Ë®≠ÂÆö„ÅØ„Åù„ÅÆ„Åæ„ÅæÁ∂≠ÊåÅ */
        body { font-family: 'Courier New', monospace; background: #050505; color: #a0a0a0; display: flex; flex-direction: column; align-items: center; margin: 0; overflow-x: hidden; }
        #setup-screen, #char-select-screen { position: fixed; inset: 0; background: #000; z-index: 1000; display: flex; flex-direction: column; justify-content: center; align-items: center; text-align: center; }
        .setup-btn, .char-btn { width: 320px; padding: 15px; margin: 5px; font-size: 14px; cursor: pointer; border: 1px solid #333; background: #111; color: #fff; text-align: left; }
        .char-btn.selected { border-color: #00ff00; background: #002200; }
        #game-layout { display: none; flex-direction: column; gap: 10px; padding: 10px; align-items: center; }
        #game-container { position: relative; width: 950px; height: 500px; background: radial-gradient(ellipse at center, #0a1018 0%, #000 100%); border-radius: 250px / 140px; border: 1px dashed #444; }
        .station { position: absolute; width: 90px; height: 35px; border: 1px solid #222; background: rgba(10, 10, 10, 0.9); display: flex; flex-direction: column; align-items: center; justify-content: center; font-size: 9px; border-radius: 2px; transform: translate(-50%, -50%); cursor: pointer; color: #666; }
        .station.selected { border: 1px solid #fff; box-shadow: 0 0 10px #fff; z-index: 100; color: #fff; }
        .station.blocked { border: 1px solid #ff0000; color: #ff4444; background: #200 !important; }
        .unit-marker { display: inline-block; width: 14px; height: 14px; border-radius: 3px; margin: 1px; font-size: 10px; text-align: center; color: white; font-weight: bold; }
        .u-a { background: #00aaff; } .u-b { background: #ff4400; }
        #controls-panel { width: 650px; background: #111; padding: 15px; border: 1px solid #333; text-align: center; }
        .unit-selector { display: flex; justify-content: center; gap: 5px; margin-bottom: 10px; }
        .unit-btn { padding: 8px; font-size: 11px; background: #222; border: 1px solid #444; color: #888; cursor: pointer; flex: 1; }
        .unit-btn.active { background: #444; color: #fff; border-color: #fff; }
        .unit-btn.done { text-decoration: line-through; opacity: 0.3; }
        .btn-group { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-top: 10px; }
        button { padding: 10px; cursor: pointer; background: #1a1a1a; color: #ccc; border: 1px solid #333; font-size: 12px; }
        #system-log { width: 650px; height: 70px; background: #000; border: 1px solid #222; margin-top: 5px; padding: 10px; font-size: 11px; overflow-y: auto; text-align: left; color: #4CAF50; }
    </style>
</head>
<body>

    <div id="setup-screen">
        <h1 style="color: #ff3333; letter-spacing: 5px;">SHADOW LINE: ONLINE</h1>
        <button class="setup-btn" onclick="preJoin('ÊçúÊüªÂÆò')">ÊçúÊüªÂÆò„Å®„Åó„Å¶ÂèÇÂä†</button>
        <button class="setup-btn" onclick="preJoin('ÁàÜÂºæÈ≠î')">ÁàÜÂºæÈ≠î„Å®„Åó„Å¶ÂèÇÂä†</button>
    </div>

    <div id="char-select-screen" style="display:none;">
        <h2 id="char-select-title">„Ç≠„É£„É©„ÇØ„Çø„ÉºÈÅ∏Êäû</h2>
        <div id="char-list"></div>
        <button class="setup-btn" id="start-game-btn" onclick="finalizeSelection()" style="margin-top:20px; text-align:center; border-color:#00ff00; display:none;">‰ΩúÊà¶ÈñãÂßã</button>
    </div>

    <div id="confirm-modal" style="position:fixed; top:50%; left:50%; transform:translate(-50%,-50%); background:#111; border:2px solid #ffeb3b; padding:20px; z-index:2000; display:none; text-align:center;">
        <p id="confirm-text"></p>
        <button onclick="processAction(true)" style="background:#00ff00; padding:10px;">ÂÆüË°å</button>
        <button onclick="processAction(false)" style="background:#555; padding:10px; color:white;">‰∏≠Ê≠¢</button>
    </div>

    <div id="game-layout">
        <div id="game-container"></div>
        <div id="controls-panel">
            <div id="score-board" style="font-size: 14px; margin-bottom: 10px;">
                Ëß£Èô§: <span id="a-score" style="color:#00aaff">0</span>/5 | ÁàÜÁ†¥: <span id="b-score" style="color:#ff4400">0</span>/5
            </div>
            <div id="unit-selector" class="unit-selector"></div>
            <div id="ability-info" style="font-size:11px; color:#ffeb3b; margin-bottom:5px;"></div>
            <div id="action-buttons" class="btn-group"></div>
            <div id="turn-info" style="margin-top:10px; font-weight:bold;"></div>
        </div>
        <div id="system-log"></div>
    </div>

<script>
// --- [Firebase Config„Çí„Åì„Åì„Å´Ë≤º„Çä‰ªò„Åë] ---
const firebaseConfig = {
  apiKey: "AIzaSyCoYzyTFHBNUbo3ZvG3sZFLdW7j0HcD91s",
  authDomain: "shadow-line-game.firebaseapp.com",
  databaseURL: "https://shadow-line-game-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "shadow-line-game",
  storageBucket: "shadow-line-game.firebasestorage.app",
  messagingSenderId: "105815703910",
  appId: "1:105815703910:web:dff1c672aa30120b9b88a7"
};
// -----------------------------------------

firebase.initializeApp(firebaseConfig);
const db = firebase.database().ref('shadow_line_game_v1');

const STATIONS = ["Êù±Âàª", "Á•û‰ºù", "ÈõªËÑ≥Ë°ó", "Âæ°ÂæíÂéü", "‰∏äÁïå", "È∂Ø„ÉéÊùú", "Êó•ÊöÆÂ≤¨", "Ë•øÊöÆ", "Áî∞Áëû", "ÈßíËæºÊ•º", "Â∑£È≠î", "Â§ßÊùü", "Ê±†Ë¢ãÁçÑ", "ÁõÆÁôΩÈö†", "È¶¨Â†¥Â¥é", "Êñ∞Â§ßÁ™™", "ÊΩúÂÆø", "‰ª£„ÄÖÈöÖ", "ÂéüÂÆøÂ±§", "Ê∏ãÂ§ú", "ÊÅµÊØîÂ∑û", "ÁõÆÈªíÁïå", "ÂèçÁî∞", "Â§ßÂ¥éË∑°", "ÂìÅÊ≤≥", "È´òËº™ÈñÄ", "Áî∞Ê∫Ä", "ÊµúÊùæÂÆÆ", "Êñ∞Á†¥", "ÊúâÊ•ΩÂ∫µ"];

const CHARS_A = [
    {id:1, name:"ÊçúÊüªÂÆò1", skill:"ÁâπÊÄ•‰πóËªä", desc:"ÁßªÂãïÁØÑÂõ≤+2(ÈÄöË°åÊ≠¢„ÇÅ‰∏çÂèØ)"},
    {id:2, name:"ÊçúÊüªÂÆò2", skill:"Âç±Èô∫‰∫àÁü•", desc:"ÊÆã„Çä1„Çø„Éº„É≥„ÅÆÁàÜÂºæ„ÇíÊ§úÁü•"},
    {id:3, name:"ÊçúÊüªÂÆò3", skill:"ËÅû„ÅçËæº„Åø", desc:"5T‰ª•ÂÜÖ„ÅÆÁàÜÂºæÈ≠îÈÄöÈÅé„ÇíË™øÊüª"},
    {id:4, name:"ÊçúÊüªÂÆò4", skill:"ÁàÜÂºæÂá¶ÁêÜ", desc:"ÁàÜÁô∫„Çí1ÂõûËÄê„Åà„Çã"},
    {id:5, name:"ÊçúÊüªÂÆò5", skill:"Ë¶ÜÈù¢ÊçúÊüª", desc:"Êïµ„ÅÆÊ§úÁü•„Çπ„Ç≠„É´ÁÑ°Âäπ"},
    {id:6, name:"ÊçúÊüªÂÆò6", skill:"ÁèæÂ†¥Ë™øÊüª", desc:"ÁàÜÁ†¥Âæå„ÅÆÊïµ„ÅÆÁßªÂãïÊñπÂêë„ÇíÁâπÂÆö"}
];

const CHARS_B = [
    {id:1, name:"ÁàÜÂºæÈ≠î1", skill:"ÊçúÊüªÁõóËÅ¥", desc:"Êïµ„ÅÆ„Ç¢„Éì„É™„ÉÜ„Ç£„ÇíÊääÊè°"},
    {id:2, name:"ÁàÜÂºæÈ≠î2", skill:"ÈõªËªäÁàÜÂºæ", desc:"ÊØé„Çø„Éº„É≥ÁßªÂãï„Åô„ÇãÁàÜÂºæ"},
    {id:3, name:"ÁàÜÂºæÈ≠î3", skill:"ÊåáÂêçÊâãÈÖç", desc:"Èö£Êé•ÈßÖ„ÅÆÊçúÊüªÂÆò„ÇíË™çË≠ò"},
    {id:4, name:"ÁàÜÂºæÈ≠î4", skill:"ÁàÜÁ†¥‰∫àÂëä", desc:"„ÉÄ„Éü„Éº„ÅÆË®≠ÁΩÆÈÄöÁü•„ÇíÈÄÅ‰ø°"}
];

let myRole = null;
let selectedCharIds = [];
let gameState = null;
let activeUnitIdx = 0;
let selectedStation = null;
let pendingAction = null;

function preJoin(role) {
    myRole = role;
    document.getElementById('setup-screen').style.display = 'none';
    document.getElementById('char-select-screen').style.display = 'flex';
    const list = document.getElementById('char-list');
    list.innerHTML = "";
    const pool = role === 'ÊçúÊüªÂÆò' ? CHARS_A : CHARS_B;
    const limit = role === 'ÊçúÊüªÂÆò' ? 4 : 2;
    document.getElementById('char-select-title').innerText = `${role} „Ç≠„É£„É©ÈÅ∏Êäû (${limit}‰Ωì)`;

    pool.forEach(c => {
        const btn = document.createElement('button');
        btn.className = 'char-btn';
        btn.innerHTML = `<strong>${c.name}: ${c.skill}</strong><br><small style="color:#aaa">${c.desc}</small>`;
        btn.onclick = () => {
            if(selectedCharIds.includes(c.id)) {
                selectedCharIds = selectedCharIds.filter(id => id !== c.id);
                btn.classList.remove('selected');
            } else if(selectedCharIds.length < limit) {
                selectedCharIds.push(c.id);
                btn.classList.add('selected');
            }
            document.getElementById('start-game-btn').style.display = selectedCharIds.length === limit ? 'block' : 'none';
        };
        list.appendChild(btn);
    });
}

function finalizeSelection() {
    document.getElementById('char-select-screen').style.display = 'none';
    document.getElementById('game-layout').style.display = 'flex';
    renderMap(); // ÂÖà„Å´Âú∞Âõ≥„ÇíÊèèÁîª
    initGameSync(); // „Åù„ÅÆÂæåÂêåÊúüÈñãÂßã
}

function renderMap() {
    const container = document.getElementById('game-container');
    container.innerHTML = ""; // ÂÜçÊèèÁîªÁî®
    STATIONS.forEach((name, i) => {
        const angle = (i / 30) * Math.PI * 2 - Math.PI / 2;
        const el = document.createElement('div');
        el.className = 'station'; el.id = `st-${i}`;
        el.style.left = (475 + 400 * Math.cos(angle)) + 'px';
        el.style.top = (250 + 200 * Math.sin(angle)) + 'px';
        el.innerHTML = `<span>${name}</span>`;
        el.onclick = () => { if(gameState && gameState.turn === myRole) { selectedStation = i; updateUI(); }};
        container.appendChild(el);
    });
}

function initGameSync() {
    db.on('value', (snapshot) => {
        const data = snapshot.val();
        if (!data) {
            // ÊúÄÂàù„ÅÆ„Éó„É¨„Ç§„É§„Éº„Åå„Éá„Éº„Çø„ÇíÂàùÊúüÂåñ
            const initialData = {
                turn: 'ÊçúÊüªÂÆò', aScore: 0, bScore: 0,
                aUnits: [0, 1, 2, 3], bUnits: [15, 16],
                aChars: myRole === 'ÊçúÊüªÂÆò' ? selectedCharIds : [1, 2, 3, 4],
                bChars: myRole === 'ÁàÜÂºæÈ≠î' ? selectedCharIds : [1, 2],
                aDone: [false, false, false, false], bDone: [false, false],
                bombs: {}, blocked: {}, blockedQueue: [], lastLog: "SYSTEM ONLINE"
            };
            db.set(initialData);
        } else {
            // 2‰∫∫ÁõÆ‰ª•Èôç„ÄÅ„Åæ„Åü„ÅØÊõ¥Êñ∞ÊôÇ„ÅÆÂá¶ÁêÜ
            gameState = data;
            // Ëá™ÂàÜ„ÅÆÈô£Âñ∂„ÅÆ„Ç≠„É£„É©„Éá„Éº„Çø„ÅåÊú™Ë®≠ÂÆö„Å™„ÇâÊõ¥Êñ∞Ôºà‰∏äÊõ∏„ÅçÔºâ
            if (myRole === 'ÊçúÊüªÂÆò' && JSON.stringify(gameState.aChars) !== JSON.stringify(selectedCharIds)) {
                db.update({ aChars: selectedCharIds });
            } else if (myRole === 'ÁàÜÂºæÈ≠î' && JSON.stringify(gameState.bChars) !== JSON.stringify(selectedCharIds)) {
                db.update({ bChars: selectedCharIds });
            }
            updateUI();
        }
    });
}

function updateUI() {
    if (!gameState) return;
    document.getElementById('a-score').innerText = gameState.aScore;
    document.getElementById('b-score').innerText = gameState.bScore;
    
    // UI„ÅÆÂêÑË¶ÅÁ¥†„ÇíÊõ¥Êñ∞
    const selector = document.getElementById('unit-selector');
    selector.innerHTML = "";
    const currentChars = myRole === 'ÊçúÊüªÂÆò' ? gameState.aChars : gameState.bChars;
    const currentDone = myRole === 'ÊçúÊüªÂÆò' ? gameState.aDone : gameState.bDone;
    
    currentChars.forEach((id, idx) => {
        const pool = myRole === 'ÊçúÊüªÂÆò' ? CHARS_A : CHARS_B;
        const charData = pool.find(c => c.id === id) || pool[0];
        const btn = document.createElement('button');
        btn.className = `unit-btn ${activeUnitIdx === idx ? 'active' : ''} ${currentDone[idx] ? 'done' : ''}`;
        btn.innerText = charData.skill;
        btn.onclick = () => { if(!currentDone[idx]) { activeUnitIdx = idx; updateUI(); }};
        selector.appendChild(btn);
    });

    const activeChar = (myRole === 'ÊçúÊüªÂÆò' ? CHARS_A : CHARS_B).find(c => c.id === currentChars[activeUnitIdx]) || {name:"", skill:""};
    document.getElementById('ability-info').innerText = `Unit: ${activeChar.name} [${activeChar.skill}]`;

    const btnContainer = document.getElementById('action-buttons');
    btnContainer.innerHTML = "";
    if (gameState.turn === myRole) {
        document.getElementById('turn-info').innerText = "YOUR TURN";
        document.getElementById('turn-info').style.color = "#00ff00";
        const actions = myRole === 'ÊçúÊüªÂÆò' ? ["ÁßªÂãï", "ÁàÜÂºæËß£Èô§", "ÊçïÁ∏õÂÆüË°å", "Âå∫ÂüüÂ∞ÅÈéñ"] : ["ÁßªÂãï", "ÁàÜÂºæË®≠ÁΩÆ", "ÈÅ†ÈöîÁàÜÁ†¥"];
        actions.forEach(a => {
            const b = document.createElement('button');
            b.innerText = a; b.disabled = currentDone[activeUnitIdx];
            b.onclick = () => { if(selectedStation !== null || a === "ÈÅ†ÈöîÁàÜÁ†¥") confirmAction(a); };
            btnContainer.appendChild(b);
        });
    } else {
        document.getElementById('turn-info').innerText = "WAITING FOR ENEMY...";
        document.getElementById('turn-info').style.color = "#ff3333";
    }

    // ÈßÖ„ÅÆÁä∂ÊÖãÂèçÊò†
    STATIONS.forEach((name, i) => {
        const el = document.getElementById(`st-${i}`);
        if(!el) return;
        el.className = 'station' + (i === selectedStation ? ' selected' : '') + (gameState.blocked && gameState.blocked[i] ? ' blocked' : '');
        el.innerHTML = `<span>${name}</span><div id="u-${i}" style="display:flex; gap:2px;"></div>`;
        const m = el.querySelector(`#u-${i}`);

        if (myRole === 'ÊçúÊüªÂÆò') {
            gameState.aUnits.forEach((p, idx) => { if(p===i) m.innerHTML += `<span class="unit-marker u-a">${idx+1}</span>`; });
            if(gameState.aChars.includes(2)) {
                for(let b in gameState.bombs) if(gameState.bombs[b] === 1 && b == i) el.innerHTML += "‚ö†Ô∏è";
            }
        } else {
            gameState.bUnits.forEach((p, idx) => { if(p===i) m.innerHTML += `<span class="unit-marker u-a" style="background:#444;">?</span>`; }); // ÊçúÊüªÂÆò„ÇíËñÑ„ÅèË°®Á§∫ÔºàÁàÜÂºæÈ≠îË¶ñÁÇπÔºâ
            gameState.bUnits.forEach((p, idx) => { if(p===i) m.innerHTML += `<span class="unit-marker u-b">${idx+1}</span>`; });
            for(let b in gameState.bombs) if(b == i) el.innerHTML += `<span style="color:#ffaa00">üí£${gameState.bombs[b]}</span>`;
        }
    });
}

function confirmAction(action) {
    pendingAction = action;
    const targetName = selectedStation !== null ? STATIONS[selectedStation] : "ÂÖ®Âüü";
    document.getElementById('confirm-text').innerText = `${targetName} „Åß „Äå${action}„Äç „ÇíÂÆüË°å„Åó„Åæ„Åô„ÅãÔºü`;
    document.getElementById('confirm-modal').style.display = 'block';
}

function processAction(yes) {
    document.getElementById('confirm-modal').style.display = 'none';
    if(!yes) return;

    let updates = JSON.parse(JSON.stringify(gameState));
    const s = selectedStation;
    const charId = (myRole === 'ÊçúÊüªÂÆò' ? updates.aChars : updates.bChars)[activeUnitIdx];
    let success = false;

    if (myRole === 'ÊçúÊüªÂÆò') {
        const cur = updates.aUnits[activeUnitIdx];
        if (pendingAction === "ÁßªÂãï") {
            const range = charId === 1 ? 3 : 1;
            if (isWithin(cur, s, range) && (!updates.blocked || !updates.blocked[s])) { updates.aUnits[activeUnitIdx] = s; success = true; }
        } else if (pendingAction === "ÁàÜÂºæËß£Èô§") {
            if (s === cur && updates.bombs && updates.bombs[s] !== undefined) { delete updates.bombs[s]; updates.aScore++; success = true; }
        } else if (pendingAction === "ÊçïÁ∏õÂÆüË°å") {
            if (s === cur && updates.bUnits.includes(s)) { alert("VICTORY: ÊçúÊüªÂÆò„ÅÆÂãùÂà©ÔºÅ"); db.set(null); location.reload(); return; }
        } else if (pendingAction === "Âå∫ÂüüÂ∞ÅÈéñ") {
            if(!updates.blocked) updates.blocked = {};
            updates.blocked[s] = 4; updates.blockedQueue.push(s);
            if(updates.blockedQueue.length > 2) { let old = updates.blockedQueue.shift(); delete updates.blocked[old]; }
            success = true;
        }
        if(success) updates.aDone[activeUnitIdx] = true;
    } else {
        const cur = updates.bUnits[activeUnitIdx];
        if (pendingAction === "ÁßªÂãï") {
            if (isWithin(cur, s, 1) && (!updates.blocked || !updates.blocked[s])) { updates.bUnits[activeUnitIdx] = s; success = true; }
        } else if (pendingAction === "ÁàÜÂºæË®≠ÁΩÆ") {
            if (s === cur) { if(!updates.bombs) updates.bombs = {}; updates.bombs[s] = 5; success = true; }
        } else if (pendingAction === "ÈÅ†ÈöîÁàÜÁ†¥") {
            let hit = false;
            for(let b in updates.bombs) if(updates.bombs[b] <= 0) { 
                updates.bScore++; if(!updates.blocked) updates.blocked = {}; updates.blocked[b] = 4;
                if(updates.aUnits.includes(parseInt(b))) { alert("VICTORY: ÁàÜÂºæÈ≠î„ÅÆÂãùÂà©ÔºÅ"); db.set(null); location.reload(); return; }
                delete updates.bombs[b]; hit = true;
            }
            if(hit) success = true;
        }
        if(success) updates.bDone[activeUnitIdx] = true;
    }

    const currentDone = myRole === 'ÊçúÊüªÂÆò' ? updates.aDone : updates.bDone;
    if (currentDone.every(d => d)) {
        updates.turn = (myRole === 'ÊçúÊüªÂÆò' ? 'ÁàÜÂºæÈ≠î' : 'ÊçúÊüªÂÆò');
        updates.aDone = [false,false,false,false];
        updates.bDone = [false,false];
        if(updates.turn === 'ÊçúÊüªÂÆò') {
            for(let b in updates.bombs) if(updates.bombs[b]>0) updates.bombs[b]--;
            for(let bl in updates.blocked) { updates.blocked[bl]--; if(updates.blocked[bl] <= 0) delete updates.blocked[bl]; }
        }
        activeUnitIdx = 0;
    } else {
        activeUnitIdx = currentDone.findIndex(d => !d);
    }
    selectedStation = null;
    db.set(updates);
}

function isWithin(p1, p2, r) { 
    for(let i=1; i<=r; i++) {
        if(p2 === (p1 - i + 30) % 30 || p2 === (p1 + i) % 30) return true;
    }
    return false;
}
</script>
</body>
</html>