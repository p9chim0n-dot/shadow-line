<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>SHADOW LINE: CROSS-PLAY</title>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-database-compat.js"></script>
    <style>
        :root { --accent-a: #00aaff; --accent-b: #ff4400; --bg: #050505; --panel-bg: #111; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); color: #ccc; margin: 0; padding: 0; touch-action: manipulation; overflow: hidden; height: 100vh; }
        
        /* „É≠„Ç∞„Ç§„É≥„Éª„Ç≠„É£„É©ÈÅ∏ÊäûÁîªÈù¢ */
        .overlay { position: fixed; inset: 0; background: #000; z-index: 2000; display: flex; flex-direction: column; justify-content: center; align-items: center; padding: 20px; text-align: center; }
        .setup-btn { width: 100%; max-width: 320px; padding: 15px; margin: 10px; font-size: 16px; border: 1px solid #444; background: #222; color: #fff; cursor: pointer; }
        .char-grid { width: 100%; max-width: 600px; display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 10px; margin: 20px 0; overflow-y: auto; }
        .char-card { background: #111; border: 1px solid #333; padding: 10px; font-size: 12px; cursor: pointer; border-radius: 4px; }
        .char-card.selected { border-color: #0f0; background: #002200; }

        /* „É°„Ç§„É≥„É¨„Ç§„Ç¢„Ç¶„Éà */
        #game-layout { display: none; flex-direction: column; height: 100vh; }
        
        /* „Éû„ÉÉ„Éó„Ç®„É™„Ç¢ */
        #map-area { flex: 1; position: relative; overflow: hidden; background: radial-gradient(circle, #0a1520 0%, #000 100%); }
        #game-container { position: absolute; width: 100%; height: 100%; }

        .station { 
            position: absolute; width: 70px; height: 35px; font-size: 10px;
            background: rgba(0,0,0,0.85); border: 1px solid #333;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            transform: translate(-50%, -50%); border-radius: 4px; color: #aaa; transition: 0.2s;
        }
        @media (min-width: 768px) { .station { width: 90px; height: 40px; font-size: 12px; } }
        .station.selected { border-color: #fff; color: #fff; box-shadow: 0 0 12px #fff; z-index: 100; }
        .station.blocked { background: #300 !important; border-color: #f00 !important; color: #f44 !important; }

        /* „É¶„Éã„ÉÉ„Éà„Éû„Éº„Ç´„Éº */
        .unit-marker { display: inline-flex; width: 14px; height: 14px; border-radius: 2px; margin: 1px; font-size: 10px; align-items: center; justify-content: center; font-weight: bold; color: #fff; }
        .u-a { background: var(--accent-a); } .u-b { background: var(--accent-b); }

        /* ‰∏ãÈÉ®Êìç‰Ωú„Éë„Éç„É´ */
        #controls { background: var(--panel-bg); border-top: 1px solid #333; padding: 10px 15px; box-sizing: border-box; }
        .info-bar { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; }
        #turn-msg { font-weight: bold; font-size: 14px; }
        .score-box { font-size: 13px; }

        .unit-tabs { display: flex; gap: 5px; margin-bottom: 10px; overflow-x: auto; }
        .tab { flex: 1; padding: 8px; font-size: 11px; background: #222; border: 1px solid #444; color: #888; white-space: nowrap; }
        .tab.active { background: #444; color: #fff; border-color: #fff; }
        .tab.done { opacity: 0.2; text-decoration: line-through; }

        .actions { display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px; }
        @media (max-width: 600px) { .actions { grid-template-columns: repeat(2, 1fr); } }
        .actions button { padding: 12px 5px; font-size: 13px; font-weight: bold; }
        
        /* „É¢„Éº„ÉÄ„É´ */
        #confirm-modal { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 85%; max-width: 320px; background: #111; border: 2px solid #ffeb3b; padding: 20px; z-index: 3000; display: none; text-align: center; border-radius: 8px; }
    </style>
</head>
<body>

<div id="setup-screen" class="overlay">
    <h1 style="color:var(--accent-b); letter-spacing:4px;">SHADOW LINE</h1>
    <button class="setup-btn" onclick="preJoin('ÊçúÊüªÂÆò')" style="border-left:10px solid var(--accent-a)">ÊçúÊüªÂÆò„ÅßÂèÇÂä†</button>
    <button class="setup-btn" onclick="preJoin('ÁàÜÂºæÈ≠î')" style="border-left:10px solid var(--accent-b)">ÁàÜÂºæÈ≠î„ÅßÂèÇÂä†</button>
</div>

<div id="char-select-screen" class="overlay" style="display:none;">
    <h2 id="char-title"></h2>
    <div id="char-list" class="char-grid"></div>
    <button class="setup-btn" id="start-btn" onclick="finalizeSelection()" style="display:none; border-color:#0f0;">„Éü„ÉÉ„Ç∑„Éß„É≥ÈñãÂßã</button>
</div>

<div id="confirm-modal">
    <p id="confirm-text" style="color:#fff; margin-bottom:20px;"></p>
    <div style="display:flex; gap:10px;">
        <button onclick="processAction(true)" style="background:#0f0; color:#000; flex:1; padding:12px;">Ê±∫ÂÆö</button>
        <button onclick="processAction(false)" style="background:#555; flex:1; padding:12px;">Êàª„Çã</button>
    </div>
</div>

<div id="game-layout">
    <div id="map-area"><div id="game-container"></div></div>
    <div id="controls">
        <div class="info-bar">
            <div id="turn-msg"></div>
            <div class="score-box">
                A: <span id="a-score" style="color:var(--accent-a)">0</span> | 
                B: <span id="b-score" style="color:var(--accent-b)">0</span>
            </div>
        </div>
        <div id="unit-tabs" class="unit-tabs"></div>
        <div id="action-btns" class="actions"></div>
    </div>
</div>

<script>
// --- [FirebaseË®≠ÂÆö] ---
const firebaseConfig = {
  apiKey: "AIzaSyCoYzyTFHBNUbo3ZvG3sZFLdW7j0HcD91s",
  authDomain: "shadow-line-game.firebaseapp.com",
  databaseURL: "https://shadow-line-game-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "shadow-line-game",
  storageBucket: "shadow-line-game.firebasestorage.app",
  messagingSenderId: "105815703910",
  appId: "1:105815703910:web:dff1c672aa30120b9b88a7"
};
// ----------------------

firebase.initializeApp(firebaseConfig);
const db = firebase.database().ref('shadow_line_crossplay_v1');

const STATIONS = ["Êù±Âàª", "Á•û‰ºù", "ÈõªËÑ≥Ë°ó", "Âæ°ÂæíÂéü", "‰∏äÁïå", "È∂Ø„ÉéÊùú", "Êó•ÊöÆÂ≤¨", "Ë•øÊöÆ", "Áî∞Áëû", "ÈßíËæºÊ•º", "Â∑£È≠î", "Â§ßÊùü", "Ê±†Ë¢ãÁçÑ", "ÁõÆÁôΩÈö†", "È¶¨Â†¥Â¥é", "Êñ∞Â§ßÁ™™", "ÊΩúÂÆø", "‰ª£„ÄÖÈöÖ", "ÂéüÂÆøÂ±§", "Ê∏ãÂ§ú", "ÊÅµÊØîÂ∑û", "ÁõÆÈªíÁïå", "ÂèçÁî∞", "Â§ßÂ¥éË∑°", "ÂìÅÊ≤≥", "È´òËº™ÈñÄ", "Áî∞Ê∫Ä", "ÊµúÊùæÂÆÆ", "Êñ∞Á†¥", "ÊúâÊ•ΩÂ∫µ"];

const ABILITIES = {
    'ÊçúÊüªÂÆò': [
        {id:1, name:"ÁâπÊÄ•", desc:"ÁßªÂãï+2"}, {id:2, name:"‰∫àÁü•", desc:"ÁàÜÂºæÊ§úÁü•"},
        {id:3, name:"ËÅûËæº", desc:"ÈÄöÈÅéÂ±•Ê≠¥"}, {id:4, name:"Âá¶ÁêÜ", desc:"1ÂõûËÄêÊÄß"},
        {id:5, name:"Ë¶ÜÈù¢", desc:"Èö†ÂØÜ"}, {id:6, name:"Ë™øÊüª", desc:"ÈÄÉËµ∞ÁâπÂÆö"}
    ],
    'ÁàÜÂºæÈ≠î': [
        {id:1, name:"ÁõóËÅ¥", desc:"ËÉΩÂäõÊääÊè°"}, {id:2, name:"ÈõªËªä", desc:"ÁßªÂãïÁàÜÂºæ"},
        {id:3, name:"ÊâãÈÖç", desc:"Êé•ËøëÊÑüÁü•"}, {id:4, name:"‰∫àÂëä", desc:"„ÉÄ„Éü„ÉºÈÄöÁü•"}
    ]
};

let myRole = null, selectedIds = [], gameState = null, activeIdx = 0, selectedSt = null, pendingAct = null;

function preJoin(role) {
    myRole = role;
    document.getElementById('setup-screen').style.display = 'none';
    document.getElementById('char-select-screen').style.display = 'flex';
    const list = document.getElementById('char-list'); list.innerHTML = "";
    const limit = role === 'ÊçúÊüªÂÆò' ? 4 : 2;
    document.getElementById('char-title').innerText = `${role} „Ç≠„É£„É©ÈÅ∏Êäû (${limit})`;

    ABILITIES[role].forEach(c => {
        const d = document.createElement('div');
        d.className = 'char-card';
        d.innerHTML = `<strong>${c.name}</strong><br>${c.desc}`;
        d.onclick = () => {
            if(selectedIds.includes(c.id)) {
                selectedIds = selectedIds.filter(i => i !== c.id);
                d.classList.remove('selected');
            } else if(selectedIds.length < limit) {
                selectedIds.push(c.id);
                d.classList.add('selected');
            }
            document.getElementById('start-btn').style.display = selectedIds.length === limit ? 'block' : 'none';
        };
        list.appendChild(d);
    });
}

function finalizeSelection() {
    document.getElementById('char-select-screen').style.display = 'none';
    document.getElementById('game-layout').style.display = 'flex';
    renderMap();
    window.addEventListener('resize', renderMap); // „É™„Çµ„Ç§„Ç∫ÊôÇ„Å´Âú∞Âõ≥„ÇíÂÜçÊèèÁîª
    initSync();
}

function renderMap() {
    const container = document.getElementById('game-container');
    container.innerHTML = "";
    const w = container.offsetWidth, h = container.offsetHeight;
    const rX = Math.min(w, h) * 0.4, rY = Math.min(w, h) * 0.42;
    const cX = w / 2, cY = h / 2;

    STATIONS.forEach((name, i) => {
        const angle = (i / 30) * Math.PI * 2 - Math.PI / 2;
        const el = document.createElement('div');
        el.className = 'station'; el.id = `st-${i}`;
        el.style.left = (cX + rX * Math.cos(angle)) + 'px';
        el.style.top = (cY + rY * Math.sin(angle)) + 'px';
        el.innerHTML = `<span>${name}</span>`;
        el.onclick = () => { if(gameState?.turn === myRole) { selectedSt = i; updateUI(); }};
        container.appendChild(el);
    });
    if(gameState) updateUI();
}

function initSync() {
    db.on('value', snap => {
        const data = snap.val();
        if(!data) {
            db.set({
                turn:'ÊçúÊüªÂÆò', aScore:0, bScore:0, aUnits:[0,1,2,3], bUnits:[15,16],
                aChars: myRole==='ÊçúÊüªÂÆò'?selectedIds:[1,2,3,4],
                bChars: myRole==='ÁàÜÂºæÈ≠î'?selectedIds:[1,2],
                aDone:[false,false,false,false], bDone:[false,false],
                bombs:{}, blocked:{}, blockedQueue:[]
            });
        } else {
            gameState = data;
            if(myRole==='ÊçúÊüªÂÆò' && !gameState.aChars) db.update({aChars: selectedIds});
            if(myRole==='ÁàÜÂºæÈ≠î' && !gameState.bChars) db.update({bChars: selectedIds});
            updateUI();
        }
    });
}

function updateUI() {
    if(!gameState) return;
    document.getElementById('a-score').innerText = gameState.aScore;
    document.getElementById('b-score').innerText = gameState.bScore;
    
    const msg = document.getElementById('turn-msg');
    msg.innerText = gameState.turn === myRole ? "YOUR TURN" : "ENEMY TURN";
    msg.style.color = gameState.turn === myRole ? "#0f0" : "#888";

    // „É¶„Éã„ÉÉ„Éà„Çø„Éñ
    const tContainer = document.getElementById('unit-tabs'); tContainer.innerHTML = "";
    const curChars = myRole==='ÊçúÊüªÂÆò'?gameState.aChars:gameState.bChars;
    const curDone = myRole==='ÊçúÊüªÂÆò'?gameState.aDone:gameState.bDone;
    
    curChars.forEach((id, idx) => {
        const char = ABILITIES[myRole].find(c => c.id === id);
        const btn = document.createElement('button');
        btn.className = `tab ${activeIdx===idx?'active':''} ${curDone[idx]?'done':''}`;
        btn.innerText = char.name;
        btn.onclick = () => { if(!curDone[idx]) { activeIdx = idx; updateUI(); }};
        tContainer.appendChild(btn);
    });

    // „Ç¢„ÇØ„Ç∑„Éß„É≥„Éú„Çø„É≥
    const bContainer = document.getElementById('action-btns'); bContainer.innerHTML = "";
    if(gameState.turn === myRole) {
        const acts = myRole==='ÊçúÊüªÂÆò'?["ÁßªÂãï","Ëß£Èô§","ÊçïÁ∏õ","Â∞ÅÈéñ"]:["ÁßªÂãï","Ë®≠ÁΩÆ","ÁàÜÁ†¥"];
        acts.forEach(a => {
            const b = document.createElement('button');
            b.innerText = a; b.disabled = curDone[activeIdx];
            b.onclick = () => { if(selectedSt!==null || a==="ÁàÜÁ†¥") confirmAct(a); };
            bContainer.appendChild(b);
        });
    }

    // „Éû„ÉÉ„ÉóÊõ¥Êñ∞
    STATIONS.forEach((name, i) => {
        const el = document.getElementById(`st-${i}`);
        if(!el) return;
        el.className = 'station' + (i===selectedSt?' selected':'') + (gameState.blocked?.[i]?' blocked':'');
        el.innerHTML = `<span>${name}</span><div id="m-${i}" style="display:flex;flex-wrap:wrap;justify-content:center;"></div>`;
        const m = el.querySelector(`#m-${i}`);
        
        if(myRole==='ÊçúÊüªÂÆò') {
            gameState.aUnits.forEach((p, idx) => { if(p===i) m.innerHTML += `<div class="unit-marker u-a">${idx+1}</div>`; });
            if(gameState.aChars?.includes(2) && Object.values(gameState.bombs||{}).includes(1) && gameState.bombs[i]===1) el.innerHTML += "‚ö†Ô∏è";
        } else {
            gameState.bUnits.forEach((p, idx) => { if(p===i) m.innerHTML += `<div class="unit-marker u-b">${idx+1}</div>`; });
            if(gameState.bombs?.[i]) el.innerHTML += `<span style="color:#f90;font-size:9px;">üí£${gameState.bombs[i]}</span>`;
        }
    });
}

function confirmAct(a) {
    pendingAct = a;
    document.getElementById('confirm-text').innerText = `${a}„ÇíÂÆüË°å„Åó„Åæ„Åô„ÅãÔºü`;
    document.getElementById('confirm-modal').style.display = 'block';
}

function processAction(yes) {
    document.getElementById('confirm-modal').style.display = 'none';
    if(!yes) return;
    let up = JSON.parse(JSON.stringify(gameState));
    const s = selectedSt, cur = (myRole==='ÊçúÊüªÂÆò'?up.aUnits:up.bUnits)[activeIdx];
    let ok = false;

    if(myRole==='ÊçúÊüªÂÆò') {
        if(pendingAct==="ÁßªÂãï") {
            const r = up.aChars[activeIdx] === 1 ? 3 : 1;
            if(isWithin(cur, s, r) && !up.blocked?.[s]) { up.aUnits[activeIdx] = s; ok = true; }
        } else if(pendingAct==="Ëß£Èô§") {
            if(s===cur && up.bombs?.[s]) { delete up.bombs[s]; up.aScore++; ok = true; }
        } else if(pendingAct==="ÊçïÁ∏õ") {
            if(s===cur && up.bUnits.includes(s)) { alert("ÊçúÊüªÂÆò„ÅÆÂãùÂà©ÔºÅ"); db.set(null); location.reload(); return; }
        } else if(pendingAct==="Â∞ÅÈéñ") {
            if(!up.blocked) up.blocked = {}; up.blocked[s] = 4; up.blockedQueue.push(s);
            if(up.blockedQueue.length > 2) delete up.blocked[up.blockedQueue.shift()]; ok = true;
        }
        if(ok) up.aDone[activeIdx] = true;
    } else {
        if(pendingAct==="ÁßªÂãï") {
            if(isWithin(cur, s, 1) && !up.blocked?.[s]) { up.bUnits[activeIdx] = s; ok = true; }
        } else if(pendingAct==="Ë®≠ÁΩÆ") {
            if(s===cur) { if(!up.bombs) up.bombs = {}; up.bombs[s] = 5; ok = true; }
        } else if(pendingAct==="ÁàÜÁ†¥") {
            for(let b in up.bombs) if(up.bombs[b] <= 0) {
                up.bScore++; if(!up.blocked) up.blocked = {}; up.blocked[b] = 4;
                if(up.aUnits.includes(parseInt(b))) { alert("ÁàÜÂºæÈ≠î„ÅÆÂãùÂà©ÔºÅ"); db.set(null); location.reload(); return; }
                delete up.bombs[b]; ok = true;
            }
        }
        if(ok) up.bDone[activeIdx] = true;
    }

    const done = myRole==='ÊçúÊüªÂÆò'?up.aDone:up.bDone;
    if(done.every(d => d)) {
        up.turn = myRole==='ÊçúÊüªÂÆò'?'ÁàÜÂºæÈ≠î':'ÊçúÊüªÂÆò';
        up.aDone = [false,false,false,false]; up.bDone = [false,false];
        if(up.turn==='ÊçúÊüªÂÆò') {
            for(let b in up.bombs) if(up.bombs[b]>0) up.bombs[b]--;
            for(let bl in up.blocked) { up.blocked[bl]--; if(up.blocked[bl]<=0) delete up.blocked[bl]; }
        }
        activeIdx = 0;
    } else { activeIdx = done.findIndex(d => !d); }
    selectedSt = null; db.set(up);
}

function isWithin(p1, p2, r) { 
    for(let i=1; i<=r; i++) if(p2 === (p1-i+30)%30 || p2 === (p1+i)%30) return true;
    return false;
}
</script>
</body>
</html>